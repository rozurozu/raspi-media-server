---
- name: Raspberry Pi 初期セットアップ
  hosts: raspi
  gather_facts: yes
  become: yes
  # ✅ 前提: Raspberry Pi OS セットアップ時に作成した管理ユーザーで接続して実行すること

  pre_tasks:
    - name: Pythonが存在するか確認する
      raw: test -e /usr/bin/python3 || (apt-get update -y && apt-get install -y python3)
      changed_when: false

    - import_tasks: tasks/pre_common.yml

    - name: 公開鍵が未指定でないか確認する
      assert:
        that:
          - admin_authorized_key | length > 0
        fail_msg: |
          管理ユーザーの公開鍵が未指定です。group_vars で admin_authorized_key を設定してください。

    - name: 公開鍵の形式が問題ないか確認する
      assert:
        that:
          - '"\n" not in admin_authorized_key'
          - '"\r" not in admin_authorized_key'
        fail_msg: |
          公開鍵は単一行で指定してください。改行を含む値はサポートしていません。




  tasks:
    - import_role:
        name: system_base

    - import_role:
        name: admin_access

    - import_role:
        name: ssh_hardening

    - import_role:
        name: ufw

    - import_role:
        name: fail2ban

    - import_role:
        name: omv_install_v2
        # name: omv_install v2はSSHが切れる前提のジョブ。よう修正

    - meta: flush_handlers
    # 以降の後続処理は ansible/playbooks/raspi_post_omv.yml に分離
    - meta: end_play
